<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo & Voice Note (åœ–æ–‡èªéŸ³ç´€éŒ„)</title>
    <style>
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background-color: #f0f2f5; 
            padding: 20px; 
            margin: 0;
            display: flex;
            justify-content: center; 
        }

        .container { 
            background: white; 
            padding: 25px; 
            border-radius: 16px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.08); 
            width: 100%;
            max-width: 500px;
        }

        h2 { text-align: center; color: #2c3e50; margin-bottom: 20px; }

        .form-group { margin-bottom: 20px; position: relative; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #34495e; }

        /* æ–‡å­—è¼¸å…¥æ¡†æ¨£å¼ */
        textarea { 
            width: 100%; 
            height: 100px;
            padding: 12px; 
            border: 2px solid #e9ecef; 
            border-radius: 8px; 
            font-size: 16px; 
            box-sizing: border-box; 
            resize: vertical; /* å…è¨±å‚ç›´æ‹‰ä¼¸ */
            font-family: inherit;
        }
        
        textarea:focus { border-color: #007bff; outline: none; }

        hr { border: 0; border-top: 1px solid #eee; margin: 25px 0; }

        /* æŒ‰éˆ•æ¨£å¼ */
        button { 
            width: 100%; padding: 14px; border: none; border-radius: 10px; 
            cursor: pointer; font-size: 16px; font-weight: 600; 
            display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: 0.2s;
        }

        /* æŒ‰éˆ•é¡è‰² */
        .btn-voice { background-color: #17a2b8; color: white; margin-top: 5px; } /* è—ç¶ è‰² */
        .btn-voice.listening { background-color: #dc3545; animation: pulse 1.5s infinite; } /* éŒ„éŸ³ä¸­è®Šç´… */

        .btn-save { background-color: #007bff; color: white; }
        .btn-view { background-color: #6c757d; color: white; }
        .camera-btn { background-color: #ffc107; color: #333; }

        .btn-group { display: flex; flex-direction: column; gap: 12px; margin-top: 30px; }

        /* åœ–ç‰‡é è¦½ */
        #preview-container { 
            margin-top: 10px; text-align: center; border: 2px dashed #cbd5e0; 
            padding: 10px; border-radius: 10px; min-height: 120px; 
            display: flex; align-items: center; justify-content: center; 
            background-color: #f8f9fa;
        }
        #preview-img { max-width: 100%; max-height: 250px; display: none; border-radius: 8px; }

        /* éš±è—ç›¸æ©Ÿ input */
        #cameraInput { opacity: 0; position: absolute; z-index: -1; width: 1px; height: 1px; }
        
        .loading { display: none; text-align: center; color: #007bff; margin-top: 15px; font-weight: bold; }

        /* éŒ„éŸ³å‹•ç•« */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>

<div class="container">
    <h2>Photo & Voice Note<br><span style="font-size: 0.7em; color: #7f8c8d; font-weight: normal;">(åœ–æ–‡èªéŸ³ç´€éŒ„)</span></h2>

    <div class="form-group">
        <label>1. Description / Note (æ–‡å­—å‚™è¨»)</label>
        <textarea id="noteInput" placeholder="Type here or use voice input... (åœ¨æ­¤è¼¸å…¥æˆ–ä½¿ç”¨èªéŸ³)"></textarea>
        
        <button type="button" class="btn-voice" id="voiceBtn" onclick="toggleVoice()">
            ğŸ¤ Tap to Speak (æŒ‰æˆ‘èªªè©±è¼¸å…¥)
        </button>
    </div>

    <hr>

    <div class="form-group">
        <label>2. Photo (ç…§ç‰‡)</label>
        <button type="button" class="camera-btn" onclick="document.getElementById('cameraInput').click()">
            ğŸ“· Take Photo (æ‹ç…§/é¸åœ–)
        </button>
        <input type="file" id="cameraInput" accept="image/*" capture="environment" onchange="previewImage(this)">
        
        <div id="preview-container">
            <span id="placeholder-text" style="color:#aaa">No Image (ç„¡åœ–ç‰‡)</span>
            <img id="preview-img">
        </div>
    </div>

    <div class="btn-group">
        <button type="button" class="btn-save" id="saveBtn" onclick="saveToGoogle()">
            ğŸ’¾ Save to Cloud (å­˜æª”è‡³é›²ç«¯)
        </button>
        <button type="button" class="btn-view" onclick="viewExcel()">
            ğŸ“Š View Excel (æª¢è¦– Excel)
        </button>
    </div>
    
    <div class="loading" id="loadingMsg">Uploading... (ä¸Šå‚³ä¸­...)</div>
</div>

<script>
    // ==========================================
    // è«‹å¡«å…¥ä½ çš„ç¶²å€
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzTDioUw8L5vZ9H3rUEB-df_sSmJ4kg86NFraktwmU4-qtiESh_u_tZPnyIsUOW9LaK/exec';
    const SHEET_VIEW_URL = 'https://docs.google.com/spreadsheets/d/1GcnAkIHAhnVjrH9bO9TQbdTUwQT17XtyQWUPh7WSTLA/edit?gid=0#gid=0';

    // ==========================================

    let base64Image = "";
    
    // --- èªéŸ³è¾¨è­˜åŠŸèƒ½ (Speech to Text) ---
    let recognition;
    let isListening = false;

    // æª¢æŸ¥ç€è¦½å™¨æ˜¯å¦æ”¯æ´èªéŸ³
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.continuous = false; // è¬›å®Œä¸€å¥è‡ªå‹•åœæ­¢
        recognition.interimResults = false; // ä¸é¡¯ç¤ºä¸­é–“éç¨‹ï¼Œåªé¡¯ç¤ºæœ€çµ‚çµæœ
        
        // è¨­å®šèªè¨€ (è‡ªå‹•åµæ¸¬ æˆ–è¨­å®šç‚º 'cmn-Hant-TW' ä¸­æ–‡)
        recognition.lang = 'cmn-Hant-TW'; // é è¨­ç¹é«”ä¸­æ–‡ï¼Œä¹Ÿå¯æ”¹ 'en-US'

        recognition.onstart = function() {
            isListening = true;
            const btn = document.getElementById('voiceBtn');
            btn.innerText = "ğŸ”´ Listening... (è½å¯«ä¸­...)";
            btn.classList.add('listening');
        };

        recognition.onend = function() {
            isListening = false;
            const btn = document.getElementById('voiceBtn');
            btn.innerText = "ğŸ¤ Tap to Speak (æŒ‰æˆ‘èªªè©±è¼¸å…¥)";
            btn.classList.remove('listening');
        };

        recognition.onresult = function(event) {
            const transcript = event.results[0][0].transcript;
            const noteArea = document.getElementById('noteInput');
            
            // å°‡èªéŸ³å…§å®¹é™„åŠ åˆ°ç¾æœ‰æ–‡å­—å¾Œæ–¹ (åŠ å€‹ç©ºæ ¼)
            if(noteArea.value.length > 0) {
                noteArea.value += " " + transcript;
            } else {
                noteArea.value = transcript;
            }
        };

        recognition.onerror = function(event) {
            alert("Voice Error: " + event.error);
            isListening = false;
        };
    } else {
        document.getElementById('voiceBtn').style.display = 'none'; //å¦‚æœä¸æ”¯æ´å°±éš±è—æŒ‰éˆ•
        alert("Your browser does not support voice input. Please use Chrome/Safari.\n(ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³ï¼Œè«‹ç”¨ Chrome æˆ– Safari)");
    }

    function toggleVoice() {
        if (!recognition) return;
        if (isListening) {
            recognition.stop();
        } else {
            recognition.start();
        }
    }

    // --- åœ–ç‰‡é è¦½ ---
    function previewImage(input) {
        if (input.files && input.files[0]) {
            var reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('preview-img').src = e.target.result;
                document.getElementById('preview-img').style.display = 'block';
                document.getElementById('placeholder-text').style.display = 'none';
                base64Image = e.target.result;
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    // --- å­˜æª” ---
    function saveToGoogle() {
        let note = document.getElementById('noteInput').value;

        // é›–ç„¶ä¸æ˜¯å¿…å¡«ï¼Œä½†å¦‚æœæœ‰å¡«æœƒæ›´å¥½
        if(note === "" && base64Image === "") {
            alert("Please enter text or take a photo!\n(è«‹è¼¸å…¥æ–‡å­—æˆ–æ‹ç…§ï¼)");
            return;
        }

        document.getElementById('saveBtn').disabled = true;
        document.getElementById('saveBtn').innerText = "Uploading...";
        document.getElementById('loadingMsg').style.display = 'block';

        let data = { 
            note: note,  // å‚³é€æ–‡å­—
            image: base64Image // å‚³é€åœ–ç‰‡
        };

        fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify(data)
        })
        .then(r => r.json())
        .then(res => {
            alert("âœ… Saved! (å·²å­˜æª”)");
            resetForm();
        })
        .catch(e => {
            console.error(e);
            alert("âŒ Error (éŒ¯èª¤)");
        })
        .finally(() => {
            document.getElementById('saveBtn').disabled = false;
            document.getElementById('saveBtn').innerText = "ğŸ’¾ Save to Cloud (å­˜æª”è‡³é›²ç«¯)";
            document.getElementById('loadingMsg').style.display = 'none';
        });
    }

    function viewExcel() {
        if(SHEET_VIEW_URL.includes("http")) window.open(SHEET_VIEW_URL, '_blank');
        else alert("Setup URL first! (è«‹è¨­å®šç¶²å€)");
    }

    function resetForm() {
        document.getElementById('noteInput').value = "";
        document.getElementById('cameraInput').value = ""; 
        document.getElementById('preview-img').style.display = 'none';
        document.getElementById('placeholder-text').style.display = 'block';
        base64Image = "";
    }
</script>

</body>
</html>


