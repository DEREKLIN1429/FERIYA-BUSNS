<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Key Notes Recorder (é‡é»äº‹é …ç´€éŒ„)</title>
    <style>
        :root {
            --primary-color: #007bff;
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
        }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: var(--bg-color); 
            margin: 0; padding: 0;
            display: flex; justify-content: center; height: 100vh;
        }

        /* --- ç™»å…¥ç•«é¢ --- */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color); z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .login-box {
            background: white; padding: 30px; border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1); text-align: center; width: 80%; max-width: 300px;
        }
        .login-input {
            width: 100%; padding: 12px; margin: 15px 0; border: 2px solid #ddd;
            border-radius: 8px; font-size: 18px; text-align: center;
        }

        /* --- ä¸»ç¨‹å¼ç•«é¢ --- */
        #app-screen { display: none; width: 100%; max-width: 500px; height: 100%; overflow-y: auto; padding: 20px; box-sizing: border-box; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .header-title h2 { margin: 0; color: #333; font-size: 1.3rem; line-height: 1.4; }
        .header-title span { font-size: 0.85em; color: #666; font-weight: normal; }
        
        .settings-icon { font-size: 26px; cursor: pointer; color: #555; padding: 8px; }

        .card { background: var(--card-bg); padding: 20px; border-radius: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .section-title { font-weight: bold; color: #555; margin-bottom: 10px; display: block; font-size: 1rem; }

        /* --- 1. åœ–ç‰‡å€ (ä¸Šæ–¹) --- */
        .photo-controls { display: flex; gap: 10px; margin-bottom: 10px; }
        .btn-half { flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: white; display: flex; align-items: center; justify-content: center; gap: 5px;}
        .btn-cam { background-color: #ffc107; color: #333; }
        .btn-gallery { background-color: #fd7e14; }

        #preview-container { 
            width: 100%; background: #eee; border-radius: 8px; 
            display: flex; align-items: center; justify-content: center; overflow: hidden;
            position: relative;
        }
        /* æ¯”ä¾‹é¡åˆ¥ */
        .ratio-4-3 { aspect-ratio: 4/3; }
        .ratio-16-9 { aspect-ratio: 16/9; }
        .ratio-1-1 { aspect-ratio: 1/1; }
        
        #preview-img { width: 100%; height: 100%; object-fit: cover; display: none; }
        .placeholder { color: #aaa; text-align: center; }

        /* --- 2. æ–‡å­—/èªéŸ³å€ (ä¸‹æ–¹) --- */
        textarea { 
            width: 100%; height: 120px; padding: 12px; border: 2px solid #eee; 
            border-radius: 8px; font-size: 16px; box-sizing: border-box; resize: none; font-family: inherit;
        }
        textarea:focus { border-color: var(--primary-color); outline: none; }
        
        .voice-controls { margin-top: 10px; }
        .btn-voice { 
            width: 100%; padding: 12px; border: none; border-radius: 8px; 
            background-color: #17a2b8; color: white; font-weight: bold; cursor: pointer;
            display: flex; justify-content: center; align-items: center; gap: 8px;
        }
        .btn-voice.recording { background-color: #dc3545; animation: pulse 1s infinite; }

        /* --- åº•éƒ¨æŒ‰éˆ• --- */
        .footer-btns { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; padding-bottom: 30px;}
        .btn-main { width: 100%; padding: 15px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; color: white; }
        .btn-save { background-color: var(--primary-color); }
        .btn-view { background-color: #6c757d; }

        /* --- è¨­å®šå½ˆçª— (Modal) --- */
        #settings-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;
        }
        .modal-content {
            background: white; width: 90%; max-width: 400px; padding: 25px; 
            border-radius: 15px; max-height: 85vh; overflow-y: auto;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px;}
        .modal-group { margin-bottom: 18px; }
        .modal-group label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 0.95rem; color: #333; }
        .modal-input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 1rem;}
        select.modal-input { background: white; }

        /* å‹•ç•« */
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
        .hidden { display: none !important; }
        .loading { text-align: center; color: var(--primary-color); font-weight: bold; margin-top: 10px; display: none; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h3>ğŸ”’ Login (ç™»å…¥)</h3>
            <p style="color:#666; font-size:0.9em;">Please enter password<br>(è«‹è¼¸å…¥å¯†ç¢¼)</p>
            <input type="password" id="loginPass" class="login-input" placeholder="Password">
            <button class="btn-main btn-save" onclick="checkLogin()">Login (é€²å…¥)</button>
        </div>
    </div>

    <div id="app-screen">
        <div class="header">
            <div class="header-title">
                <h2>Key Notes Recorder<br>é‡é»äº‹é …ç´€éŒ„</h2>
            </div>
            <div class="settings-icon" onclick="openSettings()">âš™ï¸</div>
        </div>

        <div class="card">
            <span class="section-title">1. Photo (åœ–ç‰‡ç´€éŒ„)</span>
            
            <div class="photo-controls">
                <button class="btn-half btn-cam" onclick="triggerCam()">ğŸ“· Camera (æ‹ç…§)</button>
                <button class="btn-half btn-gallery" onclick="triggerGallery()">ğŸ–¼ï¸ Gallery (ç›¸ç°¿)</button>
            </div>

            <div id="preview-container" class="ratio-4-3">
                <span class="placeholder">No Image<br>(å°šç„¡åœ–ç‰‡)</span>
                <img id="preview-img">
            </div>

            <input type="file" id="input-cam" accept="image/*" capture="environment" class="hidden" onchange="handleFile(this)">
            <input type="file" id="input-gallery" accept="image/*" class="hidden" onchange="handleFile(this)">
        </div>

        <div class="card">
            <span class="section-title">2. Note (æ–‡å­—/èªéŸ³)</span>
            <textarea id="noteInput" placeholder="After taking a photo, type here or use voice... (æ‹ç…§å¾Œï¼Œåœ¨æ­¤è¼¸å…¥æˆ–ä½¿ç”¨èªéŸ³)"></textarea>
            
            <div class="voice-controls">
                <button type="button" class="btn-voice" id="voiceBtn" onclick="toggleVoice()">
                    ğŸ¤ Start Voice (é–‹å§‹éŒ„éŸ³)
                </button>
                <div style="text-align: right; font-size: 0.85em; color: #888; margin-top: 8px;">
                    Auto-stop in <span id="display-timeout" style="color:#333; font-weight:bold;">10</span>s (è‡ªå‹•åœæ­¢)
                </div>
            </div>
        </div>

        <div class="footer-btns">
            <button class="btn-main btn-save" id="saveBtn" onclick="saveToCloud()">ğŸ’¾ Save to Cloud (å­˜æª”è‡³é›²ç«¯)</button>
            <button class="btn-main btn-view" onclick="viewExcel()">ğŸ“Š View Excel (æª¢è¦– Excel)</button>
        </div>
        <div class="loading" id="loadingMsg">Uploading... (è³‡æ–™ä¸Šå‚³ä¸­...)</div>
    </div>

    <div id="settings-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Settings (è¨­å®š)</h3>
                <button onclick="closeSettings()" style="background:none; border:none; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>

            <div class="modal-group" style="background: #f9f9f9; padding: 10px; border-radius: 8px; border: 1px dashed #ccc;">
                <label style="color:#d63384;">ğŸ”‘ Login Password (ä¿®æ”¹ç™»å…¥å¯†ç¢¼)</label>
                <input type="text" id="set-password" class="modal-input" placeholder="Current: 1234 (é è¨­)">
            </div>

            <div class="modal-group">
                <label>1. Voice Timeout (éŒ„éŸ³åœæ­¢æ™‚é–“ / ç§’)</label>
                <input type="number" id="set-timeout" class="modal-input" value="10">
            </div>

            <div class="modal-group">
                <label>2. Language (èªéŸ³è¾¨è­˜èªè¨€)</label>
                <select id="set-lang" class="modal-input">
                    <option value="cmn-Hant-TW">Traditional Chinese (ç¹é«”ä¸­æ–‡)</option>
                    <option value="en-US">English (è‹±æ–‡)</option>
                    <option value="ja-JP">Japanese (æ—¥æ–‡)</option>
                </select>
            </div>

            <div class="modal-group">
                <label>3. Photo Aspect Ratio (ç…§ç‰‡æ¯”ä¾‹)</label>
                <select id="set-ratio" class="modal-input">
                    <option value="4/3">4:3 (Standard)</option>
                    <option value="16/9">16:9 (Wide)</option>
                    <option value="1/1">1:1 (Square)</option>
                </select>
            </div>

            <div class="modal-group">
                <label>4. Upload URL (Google Script ä¸Šå‚³ç¶²å€)</label>
                <input type="text" id="set-script-url" class="modal-input" style="font-size:0.8em; color:#555;">
            </div>

            <div class="modal-group">
                <label>5. View URL (Google Sheet æª¢è¦–ç¶²å€)</label>
                <input type="text" id="set-view-url" class="modal-input" style="font-size:0.8em; color:#555;">
            </div>

            <button class="btn-main btn-save" onclick="saveSettings()">Save Settings (å„²å­˜è¨­å®š)</button>
        </div>
    </div>

<script>
    // ================= åˆå§‹åŒ–è®Šæ•¸ =================
    // åˆå§‹é è¨­å€¼
    const DEFAULT_PASS = "1234"; 
    const DEFAULT_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzTDioUw8L5vZ9H3rUEB-df_sSmJ4kg86NFraktwmU4-qtiESh_u_tZPnyIsUOW9LaK/exec";
    const DEFAULT_VIEW_URL = "https://docs.google.com/spreadsheets/d/1GcnAkIHAhnVjrH9bO9TQbdTUwQT17XtyQWUPh7WSTLA/edit?gid=0#gid=0";

    // ç‹€æ…‹è®Šæ•¸
    let processedImageBase64 = ""; 
    let recognition;
    let isRecording = false;
    let voiceTimer = null;

    // ================= 1. ç™»å…¥èˆ‡å•Ÿå‹•é‚è¼¯ =================

    window.onload = function() {
        // ç¬¬ä¸€æ¬¡ä½¿ç”¨æ™‚ï¼Œå°‡é è¨­å¯†ç¢¼å­˜å…¥
        if(!localStorage.getItem("app_password")) {
            localStorage.setItem("app_password", DEFAULT_PASS);
        }

        // æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥
        const isLoggedIn = localStorage.getItem("isLoggedIn");
        if(isLoggedIn === "true") {
            showApp();
        } else {
            document.getElementById('login-screen').style.display = 'flex';
        }
        
        loadSettingsToUI();
    };

    function checkLogin() {
        const input = document.getElementById('loginPass').value;
        const storedPass = localStorage.getItem("app_password"); // å¾å„²å­˜è®€å–å¯†ç¢¼

        if(input === storedPass) {
            localStorage.setItem("isLoggedIn", "true");
            showApp();
        } else {
            alert("Wrong Password! (å¯†ç¢¼éŒ¯èª¤)");
        }
    }

    function showApp() {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('app-screen').style.display = 'block';
        applySettings(); 
    }

    // ================= 2. è¨­å®šåŠŸèƒ½ (Settings) =================

    function openSettings() {
        loadSettingsToUI();
        document.getElementById('settings-modal').style.display = 'flex';
    }

    function closeSettings() {
        document.getElementById('settings-modal').style.display = 'none';
    }

    function saveSettings() {
        // å–å¾— UI å€¼
        const newPass = document.getElementById('set-password').value;
        const timeout = document.getElementById('set-timeout').value;
        const lang = document.getElementById('set-lang').value;
        const ratio = document.getElementById('set-ratio').value;
        const scriptUrl = document.getElementById('set-script-url').value;
        const viewUrl = document.getElementById('set-view-url').value;

        // é©—è­‰
        if(newPass.trim() === "") {
            alert("Password cannot be empty! (å¯†ç¢¼ä¸èƒ½ç©ºç™½)");
            return;
        }

        // å­˜å…¥ LocalStorage
        localStorage.setItem("app_password", newPass); // å„²å­˜æ–°å¯†ç¢¼
        localStorage.setItem("cfg_timeout", timeout);
        localStorage.setItem("cfg_lang", lang);
        localStorage.setItem("cfg_ratio", ratio);
        localStorage.setItem("cfg_script_url", scriptUrl);
        localStorage.setItem("cfg_view_url", viewUrl);

        alert("Settings Saved! (è¨­å®šå·²å„²å­˜)");
        closeSettings();
        applySettings();
    }

    function loadSettingsToUI() {
        // è®€å–è¨­å®šé¡¯ç¤ºåœ¨é¸å–®ä¸Š
        document.getElementById('set-password').value = localStorage.getItem("app_password");
        document.getElementById('set-timeout').value = localStorage.getItem("cfg_timeout") || "10";
        document.getElementById('set-lang').value = localStorage.getItem("cfg_lang") || "cmn-Hant-TW";
        document.getElementById('set-ratio').value = localStorage.getItem("cfg_ratio") || "4/3";
        document.getElementById('set-script-url').value = localStorage.getItem("cfg_script_url") || DEFAULT_SCRIPT_URL;
        document.getElementById('set-view-url').value = localStorage.getItem("cfg_view_url") || DEFAULT_VIEW_URL;
    }

    function applySettings() {
        // æ‡‰ç”¨è¨­å®šåˆ°ä¸»ç•«é¢
        const timeout = localStorage.getItem("cfg_timeout") || "10";
        document.getElementById('display-timeout').innerText = timeout;

        // æ›´æ–°åœ–ç‰‡å®¹å™¨æ¯”ä¾‹ CSS
        const ratio = localStorage.getItem("cfg_ratio") || "4/3";
        const container = document.getElementById('preview-container');
        container.className = ""; 
        if(ratio === "4/3") container.classList.add("ratio-4-3");
        else if(ratio === "16/9") container.classList.add("ratio-16-9");
        else container.classList.add("ratio-1-1");
    }

    // ================= 3. åœ–ç‰‡è™•ç† (å«è£åˆ‡) =================

    function triggerCam() { document.getElementById('input-cam').click(); }
    function triggerGallery() { document.getElementById('input-gallery').click(); }

    function handleFile(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    processImageWithCanvas(img);
                };
                img.src = e.target.result;
            }
            reader.readAsDataURL(file);
        }
    }

    function processImageWithCanvas(img) {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        const ratioStr = localStorage.getItem("cfg_ratio") || "4/3";
        let targetRatio = 4/3;
        if(ratioStr === "16/9") targetRatio = 16/9;
        if(ratioStr === "1/1") targetRatio = 1;

        let srcW = img.width;
        let srcH = img.height;
        let srcRatio = srcW / srcH;
        
        let drawW, drawH, startX, startY;

        if (srcRatio > targetRatio) {
            drawH = srcH;
            drawW = srcH * targetRatio;
            startX = (srcW - drawW) / 2;
            startY = 0;
        } else {
            drawW = srcW;
            drawH = srcW / targetRatio;
            startX = 0;
            startY = (srcH - drawH) / 2;
        }

        const MAX_WIDTH = 1000; 
        const scale = MAX_WIDTH / drawW;
        canvas.width = MAX_WIDTH;
        canvas.height = drawH * scale;

        ctx.drawImage(img, startX, startY, drawW, drawH, 0, 0, canvas.width, canvas.height);

        processedImageBase64 = canvas.toDataURL('image/jpeg', 0.8);
        
        const preview = document.getElementById('preview-img');
        preview.src = processedImageBase64;
        preview.style.display = 'block';
        document.querySelector('.placeholder').style.display = 'none';
    }

    // ================= 4. èªéŸ³åŠŸèƒ½ (Voice) =================

    function toggleVoice() {
        if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
            alert("Browser not supported (ç€è¦½å™¨ä¸æ”¯æ´)"); return;
        }

        if (isRecording) {
            stopVoice();
        } else {
            startVoice();
        }
    }

    function startVoice() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        
        recognition.lang = localStorage.getItem("cfg_lang") || 'cmn-Hant-TW';
        recognition.continuous = true;
        recognition.interimResults = false;

        recognition.onstart = function() {
            isRecording = true;
            const btn = document.getElementById('voiceBtn');
            btn.innerText = "ğŸ›‘ Stop Recording (åœæ­¢éŒ„éŸ³)";
            btn.classList.add('recording');
            
            const timeoutSec = parseInt(localStorage.getItem("cfg_timeout") || "10");
            voiceTimer = setTimeout(() => {
                stopVoice();
            }, timeoutSec * 1000);
        };

        recognition.onend = function() {
            isRecording = false;
            const btn = document.getElementById('voiceBtn');
            btn.innerText = "ğŸ¤ Start Voice (é–‹å§‹éŒ„éŸ³)";
            btn.classList.remove('recording');
            if(voiceTimer) clearTimeout(voiceTimer);
        };

        recognition.onresult = function(event) {
            const transcript = event.results[event.results.length - 1][0].transcript;
            const noteArea = document.getElementById('noteInput');
            noteArea.value += (noteArea.value ? " " : "") + transcript;
        };

        recognition.start();
    }

    function stopVoice() {
        if(recognition) recognition.stop();
        if(voiceTimer) clearTimeout(voiceTimer);
    }

    // ================= 5. å­˜æª”ä¸Šå‚³ (Upload) =================

    function saveToCloud() {
        const note = document.getElementById('noteInput').value;
        const scriptUrl = localStorage.getItem("cfg_script_url") || DEFAULT_SCRIPT_URL;

        if(!processedImageBase64 && !note) {
            alert("Empty! Please take a photo or write a note.\n(å…§å®¹ç©ºç™½ï¼è«‹æ‹ç…§æˆ–è¼¸å…¥æ–‡å­—)"); return;
        }

        const btn = document.getElementById('saveBtn');
        const loading = document.getElementById('loadingMsg');
        
        btn.disabled = true;
        loading.style.display = 'block';

        const data = { note: note, image: processedImageBase64 };

        fetch(scriptUrl, {
            method: 'POST',
            body: JSON.stringify(data)
        })
        .then(r => r.json())
        .then(res => {
            alert("âœ… Upload Success! (ä¸Šå‚³æˆåŠŸ)");
            document.getElementById('noteInput').value = "";
            processedImageBase64 = "";
            document.getElementById('preview-img').style.display = 'none';
            document.querySelector('.placeholder').style.display = 'block';
        })
        .catch(e => {
            console.error(e);
            alert("âŒ Upload Failed or Network Error.\n(ä¸Šå‚³å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¶²å€è¨­å®š)");
        })
        .finally(() => {
            btn.disabled = false;
            loading.style.display = 'none';
        });
    }

    function viewExcel() {
        const url = localStorage.getItem("cfg_view_url") || DEFAULT_VIEW_URL;
        window.open(url, '_blank');
    }
</script>

</body>
</html>
